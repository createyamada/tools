import csv
from openpyxl import load_workbook
import os

# 入力Excelファイル
input_file = "testdataA.xlsx"
output_dir = "csv_output"

# 出力フォルダがなければ作成
os.makedirs(output_dir, exist_ok=True)

# Excelファイルを開く（全シート読み込み）
wb = load_workbook(input_file, data_only=True)

for sheet_name in wb.sheetnames:
    ws = wb[sheet_name]
    print(f"🧩 シート処理中: {sheet_name}")

    # E4セルから検索キーワードを取得
    e4_value = ws["E4"].value
    if not e4_value:
        print(f"⚠️ {sheet_name}: E4セルが空のためスキップします。")
        continue
    search_key = str(e4_value).strip()
    print(f"🔍 検索キーワード: '{search_key}'")

    # 全行を取得
    rows = list(ws.iter_rows(values_only=True))
    records = []

    i = 0
    while i < len(rows):
        # 検索キーワードが含まれる行を探す
        row = [str(c).strip() if c is not None else "" for c in rows[i]]
        if any(search_key.lower() in cell.lower() for cell in row):
            # --- 可変長ブロックを取得 ---
            block_rows = []
            j = i
            while j < len(rows):
                current_row = rows[j]
                if all(c is None or str(c).strip() == "" for c in current_row):
                    break
                block_rows.append(current_row)
                j += 1
            # --- ブロック処理 ---
            header_names = [str(r[0]).strip() for r in block_rows]
            num_cols = max(len(r) for r in block_rows)

            for col in range(1, num_cols):
                record = {}
                empty_col = True
                for k, header in enumerate(header_names):
                    if header == "" or k >= len(block_rows):
                        continue
                    value = block_rows[k][col] if col < len(block_rows[k]) else None
                    if value not in (None, ""):
                        empty_col = False
                    record[header] = value
                if not empty_col:
                    records.append(record)
            i = j  # 次のブロックへ
        else:
            i += 1

    # --- 出力 ---
    if not records:
        print(f"⚠️ {sheet_name}: データが見つかりません。")
        continue

    # CSV出力用のカラム名
    fieldnames = list({key for r in records for key in r.keys()})
    output_path = os.path.join(output_dir, f"{sheet_name}.csv")

    with open(output_path, "w", newline="", encoding="utf-8-sig") as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(records)

    print(f"✅ {sheet_name}: {len(records)}件のレコードを '{output_path}' に出力しました。\n")

print("🎉 全シートの処理が完了しました。")
