import csv
from openpyxl import load_workbook
import os

# å…¥åŠ›Excelãƒ•ã‚¡ã‚¤ãƒ«
input_file = "testdataA.xlsx"
output_dir = "csv_output"

# å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œæˆ
os.makedirs(output_dir, exist_ok=True)

# Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãï¼ˆå…¨ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼‰
wb = load_workbook(input_file, data_only=True)

for sheet_name in wb.sheetnames:
    ws = wb[sheet_name]
    print(f"ğŸ§© ã‚·ãƒ¼ãƒˆå‡¦ç†ä¸­: {sheet_name}")

    # E4ã‚»ãƒ«ã‹ã‚‰æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
    e4_value = ws["E4"].value
    if not e4_value:
        print(f"âš ï¸ {sheet_name}: E4ã‚»ãƒ«ãŒç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
        continue
    search_key = str(e4_value).strip()
    print(f"ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: '{search_key}'")

    # å…¨è¡Œã‚’å–å¾—
    rows = list(ws.iter_rows(values_only=True))
    records = []

    i = 0
    while i < len(rows):
        # æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’æ¢ã™
        row = [str(c).strip() if c is not None else "" for c in rows[i]]
        if any(search_key.lower() in cell.lower() for cell in row):
            # --- å¯å¤‰é•·ãƒ–ãƒ­ãƒƒã‚¯ã‚’å–å¾— ---
            block_rows = []
            j = i
            while j < len(rows):
                current_row = rows[j]
                if all(c is None or str(c).strip() == "" for c in current_row):
                    break
                block_rows.append(current_row)
                j += 1
            # --- ãƒ–ãƒ­ãƒƒã‚¯å‡¦ç† ---
            header_names = [str(r[0]).strip() for r in block_rows]
            num_cols = max(len(r) for r in block_rows)

            for col in range(1, num_cols):
                record = {}
                empty_col = True
                for k, header in enumerate(header_names):
                    if header == "" or k >= len(block_rows):
                        continue
                    value = block_rows[k][col] if col < len(block_rows[k]) else None
                    if value not in (None, ""):
                        empty_col = False
                    record[header] = value
                if not empty_col:
                    records.append(record)
            i = j  # æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¸
        else:
            i += 1

    # --- å‡ºåŠ› ---
    if not records:
        print(f"âš ï¸ {sheet_name}: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        continue

    # CSVå‡ºåŠ›ç”¨ã®ã‚«ãƒ©ãƒ å
    fieldnames = list({key for r in records for key in r.keys()})
    output_path = os.path.join(output_dir, f"{sheet_name}.csv")

    with open(output_path, "w", newline="", encoding="utf-8-sig") as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(records)

    print(f"âœ… {sheet_name}: {len(records)}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ '{output_path}' ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚\n")

print("ğŸ‰ å…¨ã‚·ãƒ¼ãƒˆã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")
