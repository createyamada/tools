import openpyxl
import csv
import os

input_file = "testdataA.xlsx"
output_dir = "output_csv"

# 出力フォルダを作成
os.makedirs(output_dir, exist_ok=True)

wb = openpyxl.load_workbook(input_file, data_only=True)

for sheet_name in wb.sheetnames:
    ws = wb[sheet_name]
    base_header = ws["E6"].value

    if base_header is None:
        print(f"caution:{sheet_name}: E4セルに値がありません。スキップします。")
        continue

    # print(f"シート '{sheet_name}' を処理中…（基準キー: {base_header}）")

    rows = list(ws.iter_rows(values_only=True))
    records = []
    headers = []

    i = 0
    while i < len(rows):
        row = rows[i]
        # base_header を含む行を検出
        if any(str(cell).strip() == base_header for cell in row if cell):
            # ブロック（空白行まで）を取得
            block = []
            j = i
            while j < len(rows) and any(cell is not None for cell in rows[j]):
                block.append(rows[j])
                j += 1

            # 各行の最初の非Noneセルをキーに
            keys = []
            for r in block:
                # print(r)s
                first_val = next((str(c).strip() for c in r if c is not None), None)
                if first_val:
                    keys.append(first_val)

            # 初回のみヘッダー保存
            if not headers:
                headers = keys

            # データ部分を右方向に展開（1列目スキップ）
            max_len = max(len(r) for r in block)
            for col in range(1, max_len):
                record = {}
                valid = False
                for k_idx, key in enumerate(keys):
                    if k_idx < len(block) and col < len(block[k_idx]):
                        val = block[k_idx][col]
                        record[key] = val
                        if val is not None:
                            valid = True
                # 空でないレコードだけ追加

                print(record)
                if valid:
                    # print(record)
                    if record[base_header] != base_header:
                        records.append(record)

            i = j  # 次ブロックへ進む
        else:
            i += 1

    if not records:
        print(f"caution:{sheet_name}: レコードが抽出されませんでした。")
        continue

    # CSV出力
    output_file = os.path.join(output_dir, f"{sheet_name}.csv")
    with open(output_file, "w", newline="", encoding="utf-8-sig") as f:
        writer = csv.DictWriter(f, fieldnames=headers)
        writer.writeheader()
        writer.writerows(records)

    print(f"success:{len(records)}件のレコードを '{output_file}' に出力しました。\n")
