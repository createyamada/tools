import os
import re
from openpyxl import load_workbook
from openpyxl.utils import get_column_letter

# å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
target_dir = r"C:\path\to\your\folder"

# å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆãƒ¡ãƒ¢å¸³ã§é–‹ã‘ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰
output_file = os.path.join(target_dir, "æŠ½å‡ºçµæœ.txt")

# å‡ºåŠ›å†…å®¹ã‚’è“„ç©ã™ã‚‹å¤‰æ•°
output_lines = []

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®å…¨Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
for root, _, files in os.walk(target_dir):
    for file in files:
        if file.endswith(".xlsx"):
            file_path = os.path.join(root, file)
            wb = load_workbook(file_path, data_only=True)
            ws = wb.active  # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨

            # Kåˆ—ï¼ˆ11åˆ—ç›®ï¼‰ã®æœ€çµ‚è¡Œã‚’å–å¾—
            col_letter = get_column_letter(11)
            last_row = max(
                (cell.row for cell in ws[col_letter] if cell.value not in (None, "")),
                default=0
            )

            # å„ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®çµæœãƒªã‚¹ãƒˆ
            file_results = []

            # Kåˆ—ã‚’èµ°æŸ»
            for row in range(1, last_row + 1):
                cell_value = ws.cell(row=row, column=11).value
                if isinstance(cell_value, str):
                    # ã€Œâ—‹â—‹ç”»é¢ã€ ã®å½¢ã‚’ã™ã¹ã¦æŠ½å‡º
                    matches = re.findall(r'ã€Œ([^ã€Œã€]*?ç”»é¢)ã€', cell_value)
                    file_results.extend(matches)

            # çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆç”¨ã«è¿½åŠ 
            output_lines.append(f"ğŸ“˜ ãƒ•ã‚¡ã‚¤ãƒ«å: {file}")
            if file_results:
                for r in file_results:
                    output_lines.append(f"  - {r}")
            else:
                output_lines.append("  ï¼ˆè©²å½“ãªã—ï¼‰")
            output_lines.append("")  # ç©ºè¡Œã§åŒºåˆ‡ã‚Š

# === ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã— ===
with open(output_file, "w", encoding="utf-8") as f:
    f.write("\n".join(output_lines))

print(f"âœ… æŠ½å‡ºçµæœã‚’ãƒ¡ãƒ¢å¸³ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ: {output_file}")
